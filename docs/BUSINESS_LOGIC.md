# Coach Vocabulary 商業邏輯說明

## 概述

Coach Vocabulary 是一個基於**間隔重複記憶法（Spaced Repetition System, SRS）**的英語單字學習系統。系統透過科學的時間間隔安排複習，幫助用戶更有效地記憶單字。

---

## 核心概念：單字池（Word Pool）

系統將單字分為不同的「池」，代表用戶對該單字的熟練程度：

### 學習池（P0 - P6）

| 池 | 名稱 | 說明 |
|----|------|------|
| P0 | 待學習 | 用戶尚未學習的單字 |
| P1 | 新學習 | 剛學習完成，等待 10 分鐘後測驗 |
| P2 | 初級 | 通過 P1 測驗，等待 20 小時後測驗 |
| P3 | 中級 | 通過 P2 測驗，等待 44 小時後測驗 |
| P4 | 進階 | 通過 P3 測驗，等待 68 小時後測驗 |
| P5 | 高級 | 通過 P4 測驗，等待 164 小時後測驗 |
| P6 | 已掌握 | 通過 P5 測驗，完全掌握 |

### 複習池（R1 - R5）

當用戶在 P1-P5 答錯時，單字會被移到對應的 R 池：

| 池 | 對應 | 說明 |
|----|------|------|
| R1 | P1 | P1 答錯後進入 |
| R2 | P2 | P2 答錯後進入 |
| R3 | P3 | P3 答錯後進入 |
| R4 | P4 | P4 答錯後進入 |
| R5 | P5 | P5 答錯後進入 |

---

## 等待時間設定

```
P1: 10 分鐘
P2: 20 小時
P3: 44 小時
P4: 68 小時
P5: 164 小時
P6: ∞（永久掌握）

R池複習階段: 10 分鐘
R池練習階段: 20 小時
```

---

## 測驗題型

不同的池使用不同難度的測驗題型：

| 池 | 題型 | 說明 |
|----|------|------|
| P1, R1 | Reading Lv1 | 看英文選中文（四選一） |
| P2, R2 | Listening Lv1 | 聽發音選中文（四選一） |
| P3, R3 | Speaking Lv1 | 看中文唸英文（語音辨識） |
| P4, R4 | Reading Lv2 | 看英文選中文（進階難度） |
| P5, R5 | Speaking Lv2 | 看中文唸英文（進階難度） |

---

## 用戶學習流程

### 1. 新用戶註冊

```
用戶輸入用戶名 → 系統建立用戶 → 所有單字預設在 P0
```

**重要**: P0 單字不會在資料庫中建立記錄，而是透過「沒有 WordProgress 記錄」來表示。這樣的設計可以：
- 減少資料庫儲存空間
- 加快新用戶註冊速度
- 動態新增單字時無需為所有用戶建立記錄

### 2. 學習模式（Learn）

**目的**: 讓用戶認識新單字

**流程**:
```
1. 用戶進入學習模式
2. 系統檢查是否可以學習：
   - 今日學習數 < 50？
   - P1 池即將可用的單字 < 10？
   - P0 池有單字可學？
3. 若可以，取出 5 個 P0 單字
4. 顯示單字卡片（單字、翻譯、例句、圖片）
5. 用戶完成閱讀後，進行 Reading Lv1 測驗
6. 無論答對答錯，單字都移到 P1，設定 10 分鐘後可練習
```

**限制條件**:
- 每日最多學習 50 個新單字
- P1 池即將可用的單字不超過 10 個（避免堆積）

### 3. 練習模式（Practice）

**目的**: 測驗已學習的單字，幫助記憶強化

**流程**:
```
1. 用戶進入練習模式
2. 系統檢查可練習單字數 ≥ 5
3. 從以下來源取得單字（最多 5 個）：
   - P1-P5 中 next_available_time 已到的單字
   - R1-R5 中處於「練習階段」且 next_available_time 已到的單字
4. 依題型排序：Reading → Listening → Speaking
5. 用戶逐題作答
6. 提交答案後，系統處理結果
```

**答對處理**:
```
P1 答對 → P2（等待 20 小時）
P2 答對 → P3（等待 44 小時）
P3 答對 → P4（等待 68 小時）
P4 答對 → P5（等待 164 小時）
P5 答對 → P6（已掌握）

R池練習階段答對 → 回到對應 P 池（等待對應時間）
```

**答錯處理**:
```
P1 答錯 → R1（進入複習階段，等待 10 分鐘）
P2 答錯 → R2（進入複習階段，等待 10 分鐘）
P3 答錯 → R3（進入複習階段，等待 10 分鐘）
P4 答錯 → R4（進入複習階段，等待 10 分鐘）
P5 答錯 → R5（進入複習階段，等待 10 分鐘）

R池練習階段答錯 → 留在 R 池，重新進入複習階段（等待 10 分鐘）
```

### 4. 複習模式（Review）

**目的**: 重新學習答錯的單字

**R 池的兩個階段**:

#### 階段一：複習展示（Review Phase）
```
觸發條件: R池單字 is_in_review_phase=true 且 next_available_time 已到
內容: 顯示單字卡片（發音 + 圖片 + 翻譯）
完成後: 設定 is_in_review_phase=false，等待 20 小時進入練習階段
```

#### 階段二：練習測驗（Practice Phase）
```
觸發條件: R池單字 is_in_review_phase=false 且 next_available_time 已到
內容: 與練習模式相同的測驗
答對: 回到對應的 P 池
答錯: 重新進入複習階段
```

**完整複習流程**:
```
P2 答錯 → R2（複習階段）
         ↓ 等待 10 分鐘
    顯示單字卡片（複習展示）
         ↓ 完成展示
    R2（練習階段）
         ↓ 等待 20 小時
    進行測驗
         ├── 答對 → P2（等待 20 小時）
         └── 答錯 → R2（複習階段，等待 10 分鐘，重複流程）
```

---

## 狀態轉移圖

```
                    ┌─────────────────────────────────────────────┐
                    │                                             │
                    ▼                                             │
┌────┐  學習   ┌────┐  答對   ┌────┐  答對   ┌────┐  答對   ┌────┐  答對   ┌────┐
│ P0 │ ──────→ │ P1 │ ──────→ │ P2 │ ──────→ │ P3 │ ──────→ │ P4 │ ──────→ │ P5 │ ──→ P6
└────┘         └────┘         └────┘         └────┘         └────┘         └────┘
               10min          20hrs          44hrs          68hrs          164hrs
                 │              │              │              │              │
                 │答錯          │答錯          │答錯          │答錯          │答錯
                 ▼              ▼              ▼              ▼              ▼
               ┌────┐        ┌────┐        ┌────┐        ┌────┐        ┌────┐
               │ R1 │        │ R2 │        │ R3 │        │ R4 │        │ R5 │
               └────┘        └────┘        └────┘        └────┘        └────┘
                 │              │              │              │              │
                 │ 複習+測驗    │ 複習+測驗    │ 複習+測驗    │ 複習+測驗    │ 複習+測驗
                 │ 答對        │ 答對        │ 答對        │ 答對        │ 答對
                 └─────────────┴─────────────┴─────────────┴─────────────┘
                      │              │              │              │
                      ▼              ▼              ▼              ▼
                     P1             P2             P3             P4            P5
```

---

## 限制與參數

| 參數 | 值 | 說明 |
|------|-----|------|
| DAILY_LEARN_LIMIT | 50 | 每日最多學習新單字數 |
| P1_UPCOMING_LIMIT | 10 | P1 池即將可用上限 |
| LEARN_SESSION_SIZE | 5 | 每次學習的單字數 |
| PRACTICE_SESSION_SIZE | 5 | 每次練習的單字數 |
| PRACTICE_MIN_WORDS | 5 | 開始練習的最少單字數 |
| REVIEW_MIN_WORDS | 3 | 開始複習的最少單字數 |
| REVIEW_MAX_WORDS | 5 | 每次複習的最多單字數 |
| OPTIONS_COUNT | 4 | 選擇題選項數量 |

---

## 資料模型

### User（用戶）
- id: UUID
- username: 用戶名（唯一）
- created_at: 建立時間

### Word（單字）
- id: UUID
- word: 英文單字
- translation: 中文翻譯
- sentence: 英文例句
- sentence_zh: 中文例句
- image_url: 圖片路徑
- audio_url: 音檔路徑

### WordProgress（學習進度）
- id: UUID
- user_id: 用戶 ID
- word_id: 單字 ID
- pool: 目前所在池（P1-P6, R1-R5）
- learned_at: 首次學習時間
- last_practice_time: 上次練習時間
- next_available_time: 下次可練習時間
- is_in_review_phase: 是否在複習階段（R池專用）
- review_completed_time: 複習完成時間（R池專用）

**注意**: P0 單字沒有 WordProgress 記錄，透過「不存在記錄」來表示。

---

## 典型使用場景

### 場景 1: 新用戶第一天

```
09:00 - 登入，學習 5 個新單字（→ P1）
09:10 - P1 單字可練習，進行練習
        答對 4 個（→ P2），答錯 1 個（→ R1）
09:20 - R1 單字可複習，進行複習展示
        完成展示（→ R1 練習階段）
12:00 - 學習更多新單字...
```

### 場景 2: 持續學習者

```
Day 1: 學習 50 個新單字
Day 2: P1 單字進入 P2，繼續學習新單字
Day 3: P2 單字進入 P3，部分答錯進入 R 池
...
Day 7+: 大部分單字進入 P6（已掌握）
```

### 場景 3: R 池循環

```
P2 答錯 → R2（複習階段）
         ↓ 10 分鐘
    複習展示
         ↓ 20 小時
    測驗答錯 → R2（複習階段）
         ↓ 10 分鐘
    複習展示
         ↓ 20 小時
    測驗答對 → P2
         ↓ 20 小時
    測驗答對 → P3
    ...
```

---

## 選項生成邏輯

測驗題目的選項生成規則：

1. 正確答案必定包含在選項中
2. 干擾選項優先從同一 Session 的單字中選取
3. 若不足，則從所有已學習的單字中隨機選取
4. 選項順序隨機打亂
5. 返回正確答案的 index

這樣的設計確保：
- 選項都是用戶見過的單字
- 避免出現完全陌生的干擾項
- 增加測驗的合理性和挑戰性
